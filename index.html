<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Vault</title>
    <link rel="stylesheet" href="/lib/font-awesome.min.css">
    <script src="/lib/react.production.min.js"></script>
    <script src="/lib/react-dom.production.min.js"></script>
    <script src="/lib/sha1.min.js"></script>
    <script src="/lib/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/totp-generator/0.0.4/totp-generator.min.js"></script>
    <!-- Rest of your styles remain unchanged -->
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-200 to-cyan-200 dark:from-gray-900 dark:to-gray-800 transition-colors duration-500">
    <div id="root"></div>

    <script>
        // Error handling for script loading
        window.addEventListener('error', (e) => {
            if (e.target.tagName === 'SCRIPT') {
                console.error(`Failed to load script: ${e.target.src}`);
                alert('Failed to load a required script. Please check your network or try again later.');
            }
        });

        const { useState, useEffect, useContext, createContext, useRef } = React;
        const { createRoot } = ReactDOM;

        const ThemeContext = createContext();
        const AuthContext = createContext();

        // Encryption utilities
        const deriveKey = async (password, salt) => {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                { name: "PBKDF2" },
                false,
                ["deriveBits", "deriveKey"]
            );
            return crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt,
                    iterations: 600000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
            );
        };

        const encryptData = async (data, password) => {
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const key = await deriveKey(password, salt);
            const enc = new TextEncoder();
            const encrypted = await crypto.subtle.encrypt(
                { name: "AES-GCM", iv },
                key,
                enc.encode(JSON.stringify(data))
            );
            return { encrypted: new Uint8Array(encrypted), salt, iv };
        };

        const decryptData = async (encrypted, salt, iv, password) => {
            try {
                const key = await deriveKey(password, salt);
                const decrypted = await crypto.subtle.decrypt(
                    { name: "AES-GCM", iv },
                    key,
                    encrypted
                );
                const dec = new TextDecoder();
                return JSON.parse(dec.decode(decrypted));
            } catch (e) {
                throw new Error("Invalid password or corrupted data");
            }
        };

        const App = () => {
            const [theme, setTheme] = useState(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
            const [activeTab, setActiveTab] = useState('vault');
            const [passwords, setPasswords] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [showSidebar, setShowSidebar] = useState(true);
            const [masterPassword, setMasterPassword] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [sessionToken, setSessionToken] = useState(null);
            const [showTour, setShowTour] = useState(!localStorage.getItem('tourCompleted'));
            const [lastActivity, setLastActivity] = useState(Date.now());
            const [notification, setNotification] = useState(null);

            useEffect(() => {
                document.body.classList.toggle('dark', theme === 'dark');
                localStorage.setItem('theme', theme);
            }, [theme]);

            useEffect(() => {
                const timeout = setTimeout(() => {
                    if (Date.now() - lastActivity > 5 * 60 * 1000) {
                        handleLogout();
                        setNotification({ type: 'info', message: 'Session timed out due to inactivity.' });
                    }
                }, 5 * 60 * 1000);
                return () => clearTimeout(timeout);
            }, [lastActivity]);

            const toggleTheme = () => {
                setTheme(theme === 'dark' ? 'light' : 'dark');
                setLastActivity(Date.now());
            };

            const handleLogin = async (password) => {
                if (password.length < 12) {
                    setNotification({ type: 'error', message: 'Master password must be at least 12 characters.' });
                    return;
                }
                try {
                    const stored = localStorage.getItem('encryptedPasswords');
                    if (!stored) {
                        const salt = crypto.getRandomValues(new Uint8Array(16));
                        localStorage.setItem('salt', Array.from(salt).join(','));
                        setMasterPassword(password);
                        setIsAuthenticated(true);
                        setSessionToken(crypto.getRandomValues(new Uint8Array(16)).join(''));
                        setNotification({ type: 'success', message: 'Vault created successfully.' });
                        return;
                    }
                    const { encrypted, salt, iv } = JSON.parse(stored);
                    const decrypted = await decryptData(
                        new Uint8Array(encrypted),
                        new Uint8Array(salt.split(',').map(Number)),
                        new Uint8Array(iv.split(',').map(Number)),
                        password
                    );
                    setPasswords(decrypted);
                    setMasterPassword(password);
                    setIsAuthenticated(true);
                    setSessionToken(crypto.getRandomValues(new Uint8Array(16)).join(''));
                    setNotification({ type: 'success', message: 'Vault unlocked successfully.' });
                } catch (e) {
                    setNotification({ type: 'error', message: 'Incorrect master password.' });
                }
                setLastActivity(Date.now());
            };

            const handleLogout = () => {
                setPasswords([]);
                setMasterPassword('');
                setIsAuthenticated(false);
                setSessionToken(null);
                setNotification({ type: 'info', message: 'Logged out successfully.' });
                setLastActivity(Date.now());
            };

            const savePasswords = async (newPasswords) => {
                if (!sessionToken) return;
                setPasswords(newPasswords);
                if (masterPassword) {
                    const { encrypted, salt, iv } = await encryptData(newPasswords, masterPassword);
                    localStorage.setItem('encryptedPasswords', JSON.stringify({
                        encrypted: Array.from(encrypted),
                        salt: Array.from(salt).join(','),
                        iv: Array.from(iv).join(',')
                    }));
                    setNotification({ type: 'success', message: 'Passwords saved successfully.' });
                }
                setLastActivity(Date.now());
            };

            const clearAllData = () => {
                if (confirm('Are you sure you want to delete all vault data? This action cannot be undone.')) {
                    localStorage.removeItem('encryptedPasswords');
                    localStorage.removeItem('salt');
                    localStorage.removeItem('passwordHistory');
                    handleLogout();
                    setNotification({ type: 'info', message: 'All vault data cleared.' });
                }
            };

            const filteredPasswords = passwords.filter(pwd =>
                pwd.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                pwd.category.toLowerCase().includes(searchQuery.toLowerCase())
            );

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="glass p-8 rounded-3xl max-w-md w-full">
                            <h2 className="text-3xl font-bold mb-6 text-gray-900 dark:text-white text-center">Password Vault Login</h2>
                            <input
                                type="password"
                                placeholder="Enter Master Password"
                                className="w-full p-3 mb-4 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-cyan-500"
                                onChange={(e) => setMasterPassword(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleLogin(masterPassword)}
                                aria-label="Master Password"
                            />
                            <button
                                className="w-full p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction"
                                onClick={() => handleLogin(masterPassword)}
                            >
                                Unlock Vault
                            </button>
                            {notification && (
                                <div className={`mt-4 p-3 rounded-lg ${notification.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-cyan-100 text-cyan-700'}`}>
                                    {notification.message}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <ThemeContext.Provider value={{ theme, toggleTheme }}>
                    <AuthContext.Provider value={{ savePasswords, masterPassword, sessionToken }}>
                        <div className="flex h-screen" onClick={() => setLastActivity(Date.now())}>
                            {/* Sidebar */}
                            <div className={`fixed inset-y-0 left-0 w-64 bg-gray-800 dark:bg-gray-900 text-white p-4 z-50 glass ${showSidebar ? '' : 'translate-x-[-100%]'} transition-transform duration-300`}>
                                <h2 className="text-2xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-indigo-400">Password Vault</h2>
                                <input
                                    type="text"
                                    placeholder="Search passwords..."
                                    className="w-full p-2 mb-4 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    aria-label="Search passwords"
                                />
                                <nav>
                                    {['vault', 'generator', 'checker', '2fa', 'dashboard'].map(tab => (
                                        <button
                                            key={tab}
                                            className={`w-full p-2 mb-2 rounded-lg text-left ${activeTab === tab ? 'bg-cyan-600' : 'hover:bg-gray-700'} micro-interaction`}
                                            onClick={() => setActiveTab(tab)}
                                            aria-current={activeTab === tab ? 'page' : undefined}
                                        >
                                            <i className={`fa fa-${tab === 'vault' ? 'vault' : tab === 'generator' ? 'key' : tab === 'checker' ? 'shield' : tab === '2fa' ? 'lock' : 'chart-line'} mr-2`}></i>
                                            {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                        </button>
                                    ))}
                                </nav>
                                <button
                                    className="w-full p-2 mt-4 bg-red-600 hover:bg-red-700 rounded-lg micro-interaction"
                                    onClick={handleLogout}
                                >
                                    <i className="fa fa-sign-out-alt mr-2"></i> Logout
                                </button>
                                <button
                                    className="w-full p-2 mt-2 bg-gray-600 hover:bg-gray-700 rounded-lg micro-interaction"
                                    onClick={clearAllData}
                                >
                                    <i className="fa fa-trash mr-2"></i> Clear All Data
                                </button>
                                <button
                                    className="absolute top-4 right-4 p-2 rounded-full bg-cyan-600 hover:bg-cyan-700 micro-interaction"
                                    onClick={() => setShowSidebar(!showSidebar)}
                                    aria-label={showSidebar ? 'Hide sidebar' : 'Show sidebar'}
                                >
                                    <i className={`fa ${showSidebar ? 'fa-chevron-left' : 'fa-chevron-right'}`}></i>
                                </button>
                            </div>

                            {/* Main Content */}
                            <div className={`flex-1 p-4 sm:p-8 transition-all duration-300 ${showSidebar ? 'ml-64' : 'ml-0'}`}>
                                {activeTab === 'vault' && <PasswordVault passwords={filteredPasswords} />}
                                {activeTab === 'generator' && <PasswordGenerator />}
                                {activeTab === 'checker' && <PasswordChecker />}
                                {activeTab === '2fa' && <TwoFactorAuth />}
                                {activeTab === 'dashboard' && <Dashboard passwords={passwords} />}
                                <button
                                    className="fixed top-4 right-4 p-2 rounded-full bg-indigo-600 dark:bg-cyan-600 text-white hover:bg-indigo-700 dark:hover:bg-cyan-700 micro-interaction"
                                    onClick={toggleTheme}
                                    aria-label="Toggle theme"
                                >
                                    <i className={`fa ${theme === 'dark' ? 'fa-sun' : 'fa-moon'}`}></i>
                                </button>
                                {notification && (
                                    <div className={`fixed bottom-4 right-4 p-3 rounded-lg ${notification.type === 'error' ? 'bg-red-100 text-red-700' : notification.type === 'success' ? 'bg-cyan-100 text-cyan-700' : 'bg-gray-100 text-gray-700'} micro-interaction`}>
                                        {notification.message}
                                        <button
                                            className="ml-2 text-sm"
                                            onClick={() => setNotification(null)}
                                            aria-label="Close notification"
                                        >
                                            âœ•
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* Onboarding Tour */}
                            {showTour && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                    <div className="glass p-6 rounded-2xl max-w-md modal show">
                                        <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-white">Welcome to Password Vault!</h3>
                                        <p className="text-gray-700 dark:text-gray-200 mb-4">Securely manage your passwords with encrypted storage, password generation, breach checking, and 2FA setup.</p>
                                        <button
                                            className="w-full p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction"
                                            onClick={() => {
                                                localStorage.setItem('tourCompleted', 'true');
                                                setShowTour(false);
                                            }}
                                        >
                                            Get Started
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </AuthContext.Provider>
                </ThemeContext.Provider>
            );
        };

        const PasswordVault = ({ passwords }) => {
            const { savePasswords, masterPassword, sessionToken } = useContext(AuthContext);
            const [name, setName] = useState('');
            const [password, setPassword] = useState('');
            const [category, setCategory] = useState('General');
            const [showModal, setShowModal] = useState(false);
            const [editId, setEditId] = useState(null);
            const [showTooltip, setShowTooltip] = useState(false);
            const [privacyMode, setPrivacyMode] = useState(true);
            const [showShareModal, setShowShareModal] = useState(false);
            const [sharePassword, setSharePassword] = useState(null);
            const [passwordHistory, setPasswordHistory] = useState(JSON.parse(localStorage.getItem('passwordHistory')) || {});
            const addButtonRef = useRef(null);

            const setNotification = (notification) => {
                const app = document.getElementById('root')._reactRootContainer._internalRoot.current.memoizedState.element.props.children[1].props.value;
                app.setNotification(notification);
            };

            const addOrEditPassword = () => {
                if (!sessionToken) return;
                if (!name || !password) {
                    setNotification({ type: 'error', message: 'Name and password are required.' });
                    return;
                }
                const newPassword = {
                    id: editId || Date.now(),
                    name,
                    password,
                    category,
                    createdAt: new Date().toISOString(),
                    lastUsed: editId ? passwords.find(p => p.id === editId)?.lastUsed : null
                };
                const updatedPasswords = editId
                    ? passwords.map(p => (p.id === editId ? newPassword : p))
                    : [...passwords, newPassword];
                if (editId) {
                    const history = passwordHistory[editId] || [];
                    history.push({ password: passwords.find(p => p.id === editId).password, timestamp: new Date().toISOString() });
                    setPasswordHistory({ ...passwordHistory, [editId]: history });
                    localStorage.setItem('passwordHistory', JSON.stringify({ ...passwordHistory, [editId]: history }));
                }
                savePasswords(updatedPasswords);
                setName('');
                setPassword('');
                setCategory('General');
                setEditId(null);
                setShowModal(false);
            };

            const deletePassword = (id) => {
                if (!sessionToken) return;
                if (confirm("Are you sure you want to delete this password?")) {
                    savePasswords(passwords.filter(p => p.id !== id));
                    const newHistory = { ...passwordHistory };
                    delete newHistory[id];
                    setPasswordHistory(newHistory);
                    localStorage.setItem('passwordHistory', JSON.stringify(newHistory));
                }
            };

            const editPassword = (pwd) => {
                setName(pwd.name);
                setPassword(pwd.password);
                setCategory(pwd.category);
                setEditId(pwd.id);
                setShowModal(true);
            };

            const markUsed = (id) => {
                if (!sessionToken) return;
                const updatedPasswords = passwords.map(p =>
                    p.id === id ? { ...p, lastUsed: new Date().toISOString() } : p
                );
                savePasswords(updatedPasswords);
            };

            const sharePassword = async (pwd) => {
                if (!sessionToken) return;
                const { encrypted, salt, iv } = await encryptData(pwd.password, masterPassword);
                const shareData = btoa(JSON.stringify({
                    encrypted: Array.from(encrypted),
                    salt: Array.from(salt),
                    iv: Array.from(iv)
                }));
                setSharePassword(shareData);
                setShowShareModal(true);
            };

            const exportBackupKey = async () => {
                if (!sessionToken) return;
                const backupKey = crypto.getRandomValues(new Uint8Array(32)).join('');
                const { encrypted, salt, iv } = await encryptData(passwords, backupKey);
                const backupData = JSON.stringify({
                    encrypted: Array.from(encrypted),
                    salt: Array.from(salt),
                    iv: Array.from(iv),
                    backupKey
                });
                const blob = new Blob([backupData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'vault_backup.json';
                a.click();
                URL.revokeObjectURL(url);
                setNotification({ type: 'success', message: 'Backup key exported successfully.' });
            };

            const exportPasswords = () => {
                if (!sessionToken) return;
                const data = JSON.stringify(passwords);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'passwords.json';
                a.click();
                URL.revokeObjectURL(url);
            };

            const importPasswords = (e) => {
                if (!sessionToken) return;
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imported = JSON.parse(event.target.result);
                    savePasswords([...passwords, ...imported]);
                    setNotification({ type: 'success', message: 'Passwords imported successfully.' });
                };
                reader.readAsText(file);
            };

            const calculateStrength = (pwd) => {
                let score = 0;
                if (pwd.length > 8) score += 20;
                if (pwd.length > 12) score += 20;
                if (/[A-Z]/.test(pwd)) score += 20;
                if (/[a-z]/.test(pwd)) score += 20;
                if (/[0-9]/.test(pwd)) score += 10;
                if (/[^A-Za-z0-9]/.test(pwd)) score += 10;
                return score >= 80 ? 'Strong' : score >= 50 ? 'Medium' : 'Weak';
            };

            return (
                <div className="glass p-4 sm:p-8 rounded-3xl">
                    <h2 className="text-3xl font-bold mb-6 text-gray-900 dark:text-white bg-clip-text text-transparent bg-gradient-to-r from-cyan-500 to-indigo-500">Password Vault</h2>
                    <div className="flex flex-col sm:flex-row gap-2 mb-4">
                        <button
                            ref={addButtonRef}
                            className="p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction"
                            onClick={() => setShowModal(true)}
                            onMouseEnter={() => setShowTooltip(true)}
                            onMouseLeave={() => setShowTooltip(false)}
                            aria-label="Add new password"
                        >
                            <i className="fa fa-plus mr-2"></i> Add Password
                        </button>
                        {showTooltip && (
                            <div
                                className="tooltip"
                                style={{
                                    top: addButtonRef.current.offsetTop + addButtonRef.current.offsetHeight + 8,
                                    left: addButtonRef.current.offsetLeft
                                }}
                            >
                                Add a new password to your vault
                            </div>
                        )}
                        <button
                            className="p-3 bg-gray-600 text-white rounded-xl hover:bg-gray-700 micro-interaction"
                            onClick={exportPasswords}
                            aria-label="Export passwords"
                        >
                            <i className="fa fa-download mr-2"></i> Export
                        </button>
                        <label className="p-3 bg-gray-600 text-white rounded-xl hover:bg-gray-700 micro-interaction cursor-pointer">
                            <i className="fa fa-upload mr-2"></i> Import
                            <input type="file" accept=".json" onChange={importPasswords} className="hidden" aria-label="Import passwords" />
                        </label>
                        <button
                            className="p-3 bg-gray-600 text-white rounded-xl hover:bg-gray-700 micro-interaction"
                            onClick={() => setPrivacyMode(!privacyMode)}
                            aria-label={privacyMode ? 'Show passwords' : 'Hide passwords'}
                        >
                            <i className={`fa fa-${privacyMode ? 'eye-slash' : 'eye'} mr-2`}></i> {privacyMode ? 'Show' : 'Hide'}
                        </button>
                        <button
                            className="p-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 micro-interaction"
                            onClick={exportBackupKey}
                            aria-label="Export backup key"
                        >
                            <i className="fa fa-key mr-2"></i> Backup Key
                        </button>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {passwords.length === 0 ? (
                            <p className="text-gray-600 dark:text-gray-300 col-span-full text-center">No passwords stored yet.</p>
                        ) : (
                            filteredPasswords.map(pwd => (
                                <div key={pwd.id} className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg micro-interaction">
                                    <h3 className="font-semibold text-gray-900 dark:text-white">{pwd.name}</h3>
                                    <p className="text-sm text-gray-600 dark:text-gray-300">{pwd.category}</p>
                                    <p className={`text-sm text-gray-600 dark:text-gray-300 ${privacyMode ? 'blur-sensitive' : ''}`}>
                                        {pwd.password}
                                    </p>
                                    <p className="text-sm text-gray-500 dark:text-gray-400">Strength: {calculateStrength(pwd.password)}</p>
                                    <p className="text-sm text-gray-500 dark:text-gray-400">
                                        Last Used: {pwd.lastUsed ? new Date(pwd.lastUsed).toLocaleString() : 'Never'}
                                    </p>
                                    {passwordHistory[pwd.id]?.length > 0 && (
                                        <p className="text-sm text-gray-500 dark:text-gray-400">
                                            History: {passwordHistory[pwd.id].length} previous passwords
                                        </p>
                                    )}
                                    <div className="flex gap-2 mt-2">
                                        <button
                                            className="p-2 bg-cyan-600 textarelli-white rounded-lg hover:bg-cyan-700"
                                            onClick={() => { navigator.clipboard.writeText(pwd.password); markUsed(pwd.id); }}
                                            title="Copy Password"
                                            aria-label="Copy password"
                                        >
                                            <i className="fa fa-copy"></i>
                                        </button>
                                        <button
                                            className="p-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700"
                                            onClick={() => editPassword(pwd)}
                                            title="Edit Password"
                                            aria-label="Edit password"
                                        >
                                            <i className="fa fa-edit"></i>
                                        </button>
                                        <button
                                            className="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                                            onClick={() => deletePassword(pwd.id)}
                                            title="Delete Password"
                                            aria-label="Delete password"
                                        >
                                            <i className="fa fa-trash"></i>
                                        </button>
                                        <button
                                            className="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                            onClick={() => sharePassword(pwd)}
                                            title="Share Password"
                                            aria-label="Share password"
                                        >
                                            <i className="fa fa-share"></i>
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    {showModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="glass p-6 rounded-2xl max-w-md w-full modal show">
                                <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-white">{editId ? 'Edit' : 'Add'} Password</h3>
                                <input
                                    type="text"
                                    placeholder="Name (e.g., Email)"
                                    className="w-full p-3 mb-4 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-cyan-500"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    aria-label="Password name"
                                />
                                <input
                                    type="password"
                                    placeholder="Password"
                                    className="w-full p-3 mb-4 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-cyan-500"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    aria-label="Password"
                                />
                                <select
                                    className="w-full p-3 mb-4 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-cyan-500"
                                    value={category}
                                    onChange={(e) => setCategory(e.target.value)}
                                    aria-label="Password category"
                                >
                                    <option>General</option>
                                    <option>Work</option>
                                    <option>Personal</option>
                                    <option>Finance</option>
                                </select>
                                <div className="flex gap-2">
                                    <button
                                        className="flex-1 p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction"
                                        onClick={addOrEditPassword}
                                        aria-label={editId ? 'Update password' : 'Save password'}
                                    >
                                        {editId ? 'Update' : 'Save'}
                                    </button>
                                    <button
                                        className="p-3 bg-gray-600 text-white rounded-xl hover:bg-gray-700 micro-interaction"
                                        onClick={() => {
                                            setName('');
                                            setPassword('');
                                            setCategory('General');
                                            setEditId(null);
                                            setShowModal(false);
                                        }}
                                        aria-label="Cancel"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showShareModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="glass p-6 rounded-2xl max-w-md w-full modal show">
                                <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Share Password</h3>
                                <p className="text-sm text-gray-600 dark:text-gray-300 mb-4">Share this encrypted link with the recipient. They must know the master password to decrypt it.</p>
                                <input
                                    type="text"
                                    value={sharePassword}
                                    readOnly
                                    className="w-full p-3 mb-4 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                                    aria-label="Encrypted share link"
                                />
                                <div className="flex gap-2">
                                    <button
                                        className="flex-1 p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction"
                                        onClick={() => navigator.clipboard.writeText(sharePassword)}
                                        aria-label="Copy share link"
                                    >
                                        Copy Link
                                    </button>
                                    <button
                                        className="p-3 bg-gray-600 text-white rounded-xl hover:bg-gray-700 micro-interaction"
                                        onClick={() => setShowShareModal(false)}
                                        aria-label="Close"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const PasswordGenerator = () => {
            const { savePasswords, masterPassword, sessionToken } = useContext(AuthContext);
            const [length, setLength] = useState(12);
            const [options, setOptions] = useState({
                uppercase: true,
                lowercase: true,
                numbers: true,
                symbols: true,
                passphrase: false
            });
            const [password, setPassword] = useState('');
            const [showQRModal, setShowQRModal] = useState(false);
            const [expirationDays, setExpirationDays] = useState(30);
            const [showTooltip, setShowTooltip] = useState(false);
            const generateButtonRef = useRef(null);
            const qrRef = useRef(null);

            const setNotification = (notification) => {
                const app = document.getElementById('root')._reactRootContainer._internalRoot.current.memoizedState.element.props.children[1].props.value;
                app.setNotification(notification);
            };

            const generatePassword = async () => {
                if (!sessionToken) return;
                if (options.passphrase) {
                    const words = ['apple', 'blue', 'cat', 'dog', 'echo', 'fox', 'green', 'house', 'ice', 'jump'];
                    let passphrase = '';
                    for (let i = 0; i < 4; i++) {
                        const randomIndex = Math.floor(crypto.getRandomValues(new Uint32Array(1))[0] / (0xffffffff + 1) * words.length);
                        passphrase += words[randomIndex] + (i < 3 ? '-' : '');
                    }
                    setPassword(passphrase);
                    return;
                }

                const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const lowercase = 'abcdefghijklmnopqrstuvwxyz';
                const numbers = '0123456789';
                const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
                let chars = '';
                if (options.uppercase) chars += uppercase;
                if (options.lowercase) chars += lowercase;
                if (options.numbers) chars += numbers;
                if (options.symbols) chars += symbols;

                if (!chars) {
                    setNotification({ type: 'error', message: 'Please select at least one character type.' });
                    return;
                }

                let newPassword = '';
                const array = new Uint32Array(length);
                crypto.getRandomValues(array);
                for (let i = 0; i < length; i++) {
                    const randomIndex = Math.floor(array[i] / (0xffffffff + 1) * chars.length);
                    newPassword += chars[randomIndex];
                }
                setPassword(newPassword);
            };

            const generateQR = () => {
                if (!sessionToken || !password) return;
                qrRef.current.innerHTML = '';
                new QRCode(qrRef.current, {
                    text: password,
                    width: 128,
                    height: 128,
                    colorDark: '#1f2937',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                setShowQRModal(true);
            };

            const saveToVault = async () => {
                if (!sessionToken || !password) return;
                const stored = localStorage.getItem('encryptedPasswords');
                let currentPasswords = [];
                if (stored) {
                    const { encrypted, salt, iv } = JSON.parse(stored);
                    currentPasswords = await decryptData(
                        new Uint8Array(encrypted),
                        new Uint8Array(salt.split(',').map(Number)),
                        new Uint8Array(iv.split(',').map(Number)),
                        masterPassword
                    );
                }
                const newPassword = {
                    id: Date.now(),
                    name: `Generated-${new Date().toLocaleDateString()}`,
                    password,
                    category: 'General',
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + expirationDays * 24 * 60 * 60 * 1000).toISOString()
                };
                savePasswords([...currentPasswords, newPassword]);
                setNotification({ type: 'success', message: 'Password saved to vault.' });
            };

            return (
                <div className="glass p-4 sm:p-8 rounded-3xl">
                    <h2 className="text-3xl font-bold mb-6 text-gray-900 dark:text-white bg-clip-text text-transparent bg-gradient-to-r from-cyan-500 to-indigo-500">Password Generator</h2>
                    <div className="space-y-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-200">
                                Length: {length}
                            </label>
                            <input
                                type="range"
                                min="8"
                                max="32"
                                value={length}
                                onChange={(e) => setLength(e.target.value)}
                                className="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg cursor-pointer accent-cyan-500"
                                disabled={options.passphrase}
                                aria-label="Password length"
                            />
                        </div>
                        <div className="space-y-2">
                            {Object.keys(options).map(key => (
                                <label key={key} className="flex items-center">
                                    <input
                                        type="checkbox"
                                        checked={options[key]}
                                        onChange={() => setOptions({ ...options, [key]: !options[key], ...(key === 'passphrase' ? { uppercase: false, lowercase: false, numbers: false, symbols: false } : {}) })}
                                        className="h-4 w-4 text-cyan-600 focus:ring-cyan-500"
                                        disabled={key !== 'passphrase' && options.passphrase}
                                        aria-label={key}
                                    />
                                    <span className="ml-2 text-sm text-gray-700 dark:text-gray-200">
                                        {key === 'passphrase' ? 'Memorable Passphrase' : key.charAt(0).toUpperCase() + key.slice(1)}
                                    </span>
                                </label>
                            ))}
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-200">
                                Expire After (days): {expirationDays}
                            </label>
                            <input
                                type="number"
                                min="1"
                                max="365"
                                value={expirationDays}
                                onChange={(e) => setExpirationDays(e.target.value)}
                                className="w-full p-3 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-cyan-500"
                                aria-label="Expiration days"
                            />
                        </div>
                        <div className="flex items-center gap-2">
                            <input
                                type="text"
                                value={password}
                                readOnly
                                className="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-cyan-500"
                                aria-label="Generated password"
                            />
                            <button
                                className="p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction"
                                onClick={() => navigator.clipboard.writeText(password)}
                                title="Copy Password"
                                aria-label="Copy password"
                            >
                                <i className="fa fa-copy"></i>
                            </button>
                            <button
                                className="p-3 bg-gray-600 text-white rounded-xl hover:bg-gray-700 micro-interaction"
                                onClick={generateQR}
                                title="Generate QR Code"
                                aria-label="Generate QR code"
                            >
                                <i className="fa fa-qrcode"></i>
                            </button>
                            <button
                                className="p-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 micro-interaction"
                                onClick={saveToVault}
                                title="Save to Vault"
                                aria-label="Save to vault"
                            >
                                <i className="fa fa-save"></i>
                            </button>
                        </div>
                        <button
                            ref={generateButtonRef}
                            className="w-full p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction"
                            onClick={generatePassword}
                            onMouseEnter={() => setShowTooltip(true)}
                            onMouseLeave={() => setShowTooltip(false)}
                            aria-label="Generate password"
                        >
                            Generate Password
                        </button>
                        {showTooltip && (
                            <div
                                className="tooltip"
                                style={{
                                    top: generateButtonRef.current.offsetTop + generateButtonRef.current.offsetHeight + 8,
                                    left: generateButtonRef.current.offsetLeft
                                }}
                            >
                                Create a secure password or passphrase
                            </div>
                        )}
                    </div>
                    {showQRModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="glass p-6 rounded-2xl max-w-md w-full modal show">
                                <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Password QR Code</h3>
                                <div ref={qrRef} className="flex justify-center mb-4"></div>
                                <button
                                    className="w-full p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction"
                                    onClick={() => setShowQRModal(false)}
                                    aria-label="Close QR modal"
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const PasswordChecker = () => {
            const { sessionToken } = useContext(AuthContext);
            const [password, setPassword] = useState('');
            const [strength, setStrength] = useState({ score: 0, text: '', entropy: 0 });
            const [breach, setBreach] = useState({ breached: false, count: 0, checked: false });
            const [isChecking, setIsChecking] = useState(false);
            const [showPassword, setShowPassword] = useState(false);

            const setNotification = (notification) => {
                const app = document.getElementById('root')._reactRootContainer._internalRoot.current.memoizedState.element.props.children[1].props.value;
                app.setNotification(notification);
            };

            const checkStrength = () => {
                if (!password) {
                    setStrength({ score: 0, text: '', entropy: 0 });
                    return;
                }

                let score = 0;
                if (password.length > 8) score += 20;
                if (password.length > 12) score += 20;
                if (/[A-Z]/.test(password)) score += 20;
                if (/[a-z]/.test(password)) score += 20;
                if (/[0-9]/.test(password)) score += 10;
                if (/[^A-Za-z0-9]/.test(password)) score += 10;

                const entropy = (Math.log2(new Set(password).size) * password.length).toFixed(2);
                let text = score >= 80 ? 'Strong' : score >= 50 ? 'Medium' : 'Weak';
                setStrength({ score, text, entropy });
            };

            const checkBreach = async () => {
                if (!sessionToken || !password) {
                    setBreach({ breached: false, count: 0, checked: true });
                    return;
                }

                setIsChecking(true);
                const hash = sha1(password).toUpperCase();
                const prefix = hash.slice(0, 5);
                const suffix = hash.slice(5);

                try {
                    const response = await fetch(`https://api.pwnedpasswords.com/range/${prefix}`);
                    const text = await response.text();
                    const lines = text.split('\n');
                    for (let line of lines) {
                        const [hashSuffix, count] = line.split(':');
                        if (hashSuffix === suffix) {
                            setBreach({ breached: true, count: parseInt(count), checked: true });
                            setIsChecking(false);
                            setNotification({ type: 'error', message: `Password found in ${count} breaches!` });
                            return;
                        }
                    }
                    setBreach({ breached: false, count: 0, checked: true });
                    setNotification({ type: 'success', message: 'No breaches found.' });
                } catch (error) {
                    console.error('Error checking breach:', error);
                    setBreach({ breached: false, count: 0, checked: true });
                    setNotification({ type: 'error', message: 'Failed to check breaches.' });
                }
                setIsChecking(false);
            };

            useEffect(() => {
                checkStrength();
            }, [password]);

            return (
                <div className="glass p-4 sm:p-8 rounded-3xl">
                    <h2 className="text-3xl font-bold mb-6 text-gray-900 dark:text-white bg-clip-text text-transparent bg-gradient-to-r from-cyan-500 to-indigo-500">Password Checker</h2>
                    <div className="relative mb-4">
                        <input
                            type={showPassword ? 'text' : 'password'}
                            placeholder="Enter password to check"
                            className="w-full p-3 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-cyan-500"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && checkBreach()}
                            aria-label="Password to check"
                        />
                        <button
                            className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-100"
                            onClick={() => setShowPassword(!showPassword)}
                            aria-label={showPassword ? 'Hide password' : 'Show password'}
                        >
                            <i className={`fa ${showPassword ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                        </button>
                    </div>
                    <button
                        className="w-full p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction flex items-center justify-center"
                        onClick={checkBreach}
                        disabled={isChecking}
                        aria-label="Check password for breaches"
                    >
                        {isChecking ? (
                            <span className="flex items-center">
                                <span className="spinner mr-2"></span> Checking...
                            </span>
                        ) : (
                            'Check Password'
                        )}
                    </button>
                    {strength.score > 0 && (
                        <div className="mt-4">
                            <div className={`strength-bar w-${strength.score}/5 ${strength.text === 'Strong' ? 'bg-cyan-500' : strength.text === 'Medium' ? 'bg-yellow-400' : 'bg-red-500'}`}></div>
                            <p className="text-sm text-gray-600 dark:text-gray-300 mt-2">Strength: {strength.text}</p>
                            <p className="text-sm text-gray-600 dark:text-gray-300">Entropy: {strength.entropy} bits</p>
                        </div>
                    )}
                    {breach.checked && (
                        <p className={`text-sm mt-2 ${breach.breached ? 'text-red-600 dark:text-red-400' : 'text-cyan-600 dark:text-cyan-400'}`}>
                            {breach.breached
                                ? `Warning: This password was found in ${breach.count} breaches!`
                                : 'No breaches found. This password appears safe.'}
                        </p>
                    )}
                </div>
            );
        };

        const TwoFactorAuth = () => {
            const { sessionToken } = useContext(AuthContext);
            const [secret, setSecret] = useState('');
            const [serviceName, setServiceName] = useState('');
            const [showQRModal, setShowQRModal] = useState(false);
            const qrRef = useRef(null);

            const setNotification = (notification) => {
                const app = document.getElementById('root')._reactRootContainer._internalRoot.current.memoizedState.element.props.children[1].props.value;
                app.setNotification(notification);
            };

            const generate2FASecret = () => {
                if (!sessionToken) return;
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
                let newSecret = '';
                const array = new Uint32Array(16);
                crypto.getRandomValues(array);
                for (let i = 0; i < 16; i++) {
                    const randomIndex = Math.floor(array[i] / (0xffffffff + 1) * chars.length);
                    newSecret += chars[randomIndex];
                }
                setSecret(newSecret);
            };

            const generateQR = () => {
                if (!sessionToken || !secret || !serviceName) {
                    setNotification({ type: 'error', message: 'Please enter a service name and generate a secret.' });
                    return;
                }
                qrRef.current.innerHTML = '';
                const otpauth = `otpauth://totp/${encodeURIComponent(serviceName)}?secret=${secret}&issuer=PasswordVault`;
                new QRCode(qrRef.current, {
                    text: otpauth,
                    width: 128,
                    height: 128,
                    colorDark: '#1f2937',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                setShowQRModal(true);
            };

            return (
                <div className="glass p-4 sm:p-8 rounded-3xl">
                    <h2 className="text-3xl font-bold mb-6 text-gray-900 dark:text-white bg-clip-text text-transparent bg-gradient-to-r from-cyan-500 to-indigo-500">2FA Setup</h2>
                    <div className="space-y-4">
                        <input
                            type="text"
                            placeholder="Service Name (e.g., Email)"
                            className="w-full p-3 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-cyan-500"
                            value={serviceName}
                            onChange={(e) => setServiceName(e.target.value)}
                            aria-label="Service name"
                        />
                        <div className="flex items-center gap-2">
                            <input
                                type="text"
                                value={secret}
                                readOnly
                                className="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-cyan-500"
                                placeholder="Generate a 2FA secret"
                                aria-label="2FA secret"
                            />
                            <button
                                className="p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction"
                                onClick={() => navigator.clipboard.writeText(secret)}
                                title="Copy Secret"
                                aria-label="Copy 2FA secret"
                            >
                                <i className="fa fa-copy"></i>
                            </button>
                        </div>
                        <div className="flex gap-2">
                            <button
                                className="flex-1 p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction"
                                onClick={generate2FASecret}
                                aria-label="Generate 2FA secret"
                            >
                                Generate Secret
                            </button>
                            <button
                                className="p-3 bg-gray-600 text-white rounded-xl hover:bg-gray-700 micro-interaction"
                                onClick={generateQR}
                                aria-label="Show QR code"
                            >
                                Show QR Code
                            </button>
                        </div>
                    </div>
                    {showQRModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="glass p-6 rounded-2xl max-w-md w-full modal show">
                                <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-white">2FA QR Code</h3>
                                <p className="text-sm text-gray-600 dark:text-gray-300 mb-4">Scan with your authenticator app (e.g., Google Authenticator).</p>
                                <div ref={qrRef} className="flex justify-center mb-4"></div>
                                <button
                                    className="w-full p-3 bg-cyan-600 text-white rounded-xl hover:bg-cyan-700 micro-interaction"
                                    onClick={() => setShowQRModal(false)}
                                    aria-label="Close QR modal"
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Dashboard = ({ passwords }) => {
            const strongPasswords = passwords.filter(pwd => {
                let score = 0;
                if (pwd.password.length > 8) score += 20;
                if (pwd.password.length > 12) score += 20;
                if (/[A-Z]/.test(pwd.password)) score += 20;
                if (/[a-z]/.test(pwd.password)) score += 20;
                if (/[0-9]/.test(pwd.password)) score += 10;
                if (/[^A-Za-z0-9]/.test(pwd.password)) score += 10;
                return score >= 80;
            }).length;

            const expiredPasswords = passwords.filter(pwd => pwd.expiresAt && new Date(pwd.expiresAt) < new Date()).length;

            return (
                <div className="glass p-4 sm:p-8 rounded-3xl">
                    <h2 className="text-3xl font-bold mb-6 text-gray-900 dark:text-white bg-clip-text text-transparent bg-gradient-to-r from-cyan-500 to-indigo-500">Password Health Dashboard</h2>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg micro-interaction">
                            <h3 className="font-semibold text-gray-900 dark:text-white">Total Passwords</h3>
                            <p className="text-2xl text-cyan-600 dark:text-cyan-400">{passwords.length}</p>
                        </div>
                        <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg micro-interaction">
                            <h3 className="font-semibold text-gray-900 dark:text-white">Strong Passwords</h3>
                            <p className="text-2xl text-cyan-600 dark:text-cyan-400">{strongPasswords}</p>
                        </div>
                        <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg micro-interaction">
                            <h3 className="font-semibold text-gray-900 dark:text-white">Expired Passwords</h3>
                            <p className="text-2xl text-red-600 dark:text-red-400">{expiredPasswords}</p>
                        </div>
                        <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg micro-interaction">
                            <h3 className="font-semibold text-gray-900 dark:text-white">Categories</h3>
                            <p className="text-2xl text-cyan-600 dark:text-cyan-400">{new Set(passwords.map(pwd => pwd.category)).size}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
